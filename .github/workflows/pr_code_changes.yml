# This workflow outlines tasks that are ran when a pull request that modifies source code is made, such as building a preview

name: "PR: Code Changes"

on:
  pull_request:
    branches: [main]
    paths:
      - "**.cs"

jobs:
  Build:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        
      - name: Post/Edit Initial Comment
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
            ### Building ${{ github.action_repository }} <span aria-hidden="true">üöß</span>
            This could take several minutes to complete, when finished this comment will be edited.

            |  Name | Detail |
            |---------------------------------|------------------------------------------------------------------------------------|
            | **Commit** 						          | ${{ github.sha }}                                                                  |
            | **Logs** 							          | ${{ github.server_url }}${{ github.repository }}/actions/runs/${{ github.run_id }} |
            | **Build Environment** 			    | ${{ runner.os }}/${{ runner.arch }}                                                |
            | **Triggered By**							  | [${{ github.actor }}](https://github.com/${{ github.actor }})                      |
            
            identifier: preview-build
          comment_includes: "preview build"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 6.0.x

      - name: Restore Dependencies
        run: dotnet restore

      - name: Download Dalamud Library
        run: |
          cd src
          wget -O Lib.zip https://goatcorp.github.io/dalamud-distrib/latest.zip
          unzip Lib.zip -d Lib
          export IsCI=true

      - name: Build Plugin
        run: |
          dotnet build
          dotnet build --configuration Release

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: ./src/bin
          
      - name: Edit Comment (Success)
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
            ### Build Complete for ${{ github.action_repository }} <span aria-hidden="true">‚úÖ</span>
            No failures were recorded when building the Plugin and an artifact has been uploaded. 
            
            ‚ö†Ô∏è Please review all code changes before downloading the Artifact for security. Users should never use developer builds from pull requests. 

            |  Name | Detail |
            |---------------------------------|------------------------------------------------------------------------------------|
            | **Commit** 						          | ${{ github.sha }}                                                                  |
            | **Artifact URL** 							  | ${{ github.server_url }}${{ github.repository }}/actions/runs/${{ github.run_id }} |
            | **Build Environment** 			    | ${{ runner.os }}/${{ runner.arch }}                                                |
            | **Triggered By**							  | [${{ github.actor }}](https://github.com/${{ github.actor }})                      |
            
            identifier: preview-build
          comment_includes: "preview build"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Edit Comment (Failure)
        if: ${{ failure() }}
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
            ### Build Failed for ${{ github.action_repository }} <span aria-hidden="true">‚ùå</span>
            Something went wrong during the build of the plugin. Please view the logs to find out more information.
            

            |  Name | Detail |
            |---------------------------------|------------------------------------------------------------------------------------|
            | **Commit** 						          | ${{ github.sha }}                                                                  |
            | **Artifact URL** 							  | ${{ github.server_url }}${{ github.repository }}/actions/runs/${{ github.run_id }} |
            | **Build Environment** 			    | ${{ runner.os }}/${{ runner.arch }}                                                |
            | **Triggered By**							  | [${{ github.actor }}](https://github.com/${{ github.actor }})                      |
            
            identifier: preview-build
          comment_includes: "preview build"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
